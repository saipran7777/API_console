(function(mod){if("object"==typeof exports&&"object"==typeof module)mod(require("../../lib/codemirror"),require("../htmlmixed/htmlmixed"));else if("function"==typeof define&&define.amd)define(["../../lib/codemirror","../htmlmixed/htmlmixed"],mod);else mod(CodeMirror)})(function(CodeMirror){"use strict";var indentingTags=["template","literal","msg","fallbackmsg","let","if","elseif","else","switch","case","default","foreach","ifempty","for","call","param","deltemplate","delcall","log"];CodeMirror.defineMode("soy",function(config){var textMode=CodeMirror.getMode(config,"text/plain"),modes={html:CodeMirror.getMode(config,{name:"text/html",multilineTagIndentFactor:2,multilineTagIndentPastTag:!1}),attributes:textMode,text:textMode,uri:textMode,trusted_resource_uri:textMode,css:CodeMirror.getMode(config,"text/css"),js:CodeMirror.getMode(config,{name:"text/javascript",statementIndent:2*config.indentUnit})};function last(array){return array[array.length-1]}function tokenUntil(stream,state,untilRegExp){if(stream.sol()){for(var indent=0;indent<state.indent;indent++){if(!stream.eat(/\s/))break}if(indent)return null}var oldString=stream.string,match=untilRegExp.exec(oldString.substr(stream.pos));if(match){stream.string=oldString.substr(0,stream.pos+match.index)}var result=stream.hideFirstChars(state.indent,function(){var localState=last(state.localStates);return localState.mode.token(stream,localState.state)});stream.string=oldString;return result}function contains(list,element){while(list){if(list.element===element)return!0;list=list.next}return!1}function prepend(list,element){return{element:element,next:list}}function ref(list,name,loose){return contains(list,name)?"variable-2":loose?"variable":"variable-2 error"}function popscope(state){if(state.scopes){state.variables=state.scopes.element;state.scopes=state.scopes.next}}return{startState:function(){return{kind:[],kindTag:[],soyState:[],templates:null,variables:prepend(null,"ij"),scopes:null,indent:0,quoteKind:null,localStates:[{mode:modes.html,state:CodeMirror.startState(modes.html)}]}},copyState:function(state){return{tag:state.tag,kind:state.kind.concat([]),kindTag:state.kindTag.concat([]),soyState:state.soyState.concat([]),templates:state.templates,variables:state.variables,scopes:state.scopes,indent:state.indent,quoteKind:state.quoteKind,localStates:state.localStates.map(function(localState){return{mode:localState.mode,state:CodeMirror.copyState(localState.mode,localState.state)}})}},token:function(stream,state){var match;switch(last(state.soyState)){case"comment":if(stream.match(/^.*?\*\//)){state.soyState.pop()}else{stream.skipToEnd()}if(!state.scopes){for(var paramRe=/@param\??\s+(\S+)/g,current=stream.current(),match;match=paramRe.exec(current);){state.variables=prepend(state.variables,match[1])}}return"comment";case"string":var match=stream.match(/^.*?(["']|\\[\s\S])/);if(!match){stream.skipToEnd()}else if(match[1]==state.quoteKind){state.quoteKind=null;state.soyState.pop()}return"string";}if(!state.soyState.length||"literal"!=last(state.soyState)){if(stream.match(/^\/\*/)){state.soyState.push("comment");return"comment"}else if(stream.match(stream.sol()?/^\s*\/\/.*/:/^\s+\/\/.*/)){return"comment"}}switch(last(state.soyState)){case"templ-def":if(match=stream.match(/^\.?([\w]+(?!\.[\w]+)*)/)){state.templates=prepend(state.templates,match[1]);state.scopes=prepend(state.scopes,state.variables);state.soyState.pop();return"def"}stream.next();return null;case"templ-ref":if(match=stream.match(/^\.?([\w]+)/)){state.soyState.pop();if("."==match[0][0]){return ref(state.templates,match[1],!0)}return"variable"}stream.next();return null;case"param-def":if(match=stream.match(/^\w+/)){state.variables=prepend(state.variables,match[0]);state.soyState.pop();state.soyState.push("param-type");return"def"}stream.next();return null;case"param-type":if("}"==stream.peek()){state.soyState.pop();return null}if(stream.eatWhile(/^[\w]+/)){return"variable-3"}stream.next();return null;case"var-def":if(match=stream.match(/^\$([\w]+)/)){state.variables=prepend(state.variables,match[1]);state.soyState.pop();return"def"}stream.next();return null;case"tag":if(stream.match(/^\/?}/)){if("/template"==state.tag||"/deltemplate"==state.tag){popscope(state);state.variables=prepend(null,"ij");state.indent=0}else{if("/for"==state.tag||"/foreach"==state.tag){popscope(state)}state.indent-=config.indentUnit*("/}"==stream.current()||-1==indentingTags.indexOf(state.tag)?2:1)}state.soyState.pop();return"keyword"}else if(stream.match(/^([\w?]+)(?==)/)){if("kind"==stream.current()&&(match=stream.match(/^="([^"]+)/,!1))){var kind=match[1];state.kind.push(kind);state.kindTag.push(state.tag);var mode=modes[kind]||modes.html,localState=last(state.localStates);if(localState.mode.indent){state.indent+=localState.mode.indent(localState.state,"")}state.localStates.push({mode:mode,state:CodeMirror.startState(mode)})}return"attribute"}else if(match=stream.match(/^["']/)){state.soyState.push("string");state.quoteKind=match;return"string"}if(match=stream.match(/^\$([\w]+)/)){return ref(state.variables,match[1])}if(match=stream.match(/^\w+/)){return /^(?:as|and|or|not|in)$/.test(match[0])?"keyword":null}stream.next();return null;case"literal":if(stream.match(/^(?=\{\/literal})/)){state.indent-=config.indentUnit;state.soyState.pop();return this.token(stream,state)}return tokenUntil(stream,state,/\{\/literal}/);}if(stream.match(/^\{literal}/)){state.indent+=config.indentUnit;state.soyState.push("literal");return"keyword"}else if(match=stream.match(/^\{([/@\\]?\w+\??)(?=$|[\s}]|\/[/*])/)){if("/switch"!=match[1])state.indent+=(/^(\/|(else|elseif|ifempty|case|fallbackmsg|default)$)/.test(match[1])&&"switch"!=state.tag?1:2)*config.indentUnit;state.tag=match[1];if(state.tag=="/"+last(state.kindTag)){state.kind.pop();state.kindTag.pop();state.localStates.pop();var localState=last(state.localStates);if(localState.mode.indent){state.indent-=localState.mode.indent(localState.state,"")}}state.soyState.push("tag");if("template"==state.tag||"deltemplate"==state.tag){state.soyState.push("templ-def")}else if("call"==state.tag||"delcall"==state.tag){state.soyState.push("templ-ref")}else if("let"==state.tag){state.soyState.push("var-def")}else if("for"==state.tag||"foreach"==state.tag){state.scopes=prepend(state.scopes,state.variables);state.soyState.push("var-def")}else if("namespace"==state.tag){if(!state.scopes){state.variables=prepend(null,"ij")}}else if(state.tag.match(/^@(?:param\??|inject)/)){state.soyState.push("param-def")}return"keyword"}else if(stream.eat("{")){state.tag="print";state.indent+=2*config.indentUnit;state.soyState.push("tag");return"keyword"}return tokenUntil(stream,state,/\{|\s+\/\/|\/\*/)},indent:function(state,textAfter){var indent=state.indent,top=last(state.soyState);if("comment"==top)return CodeMirror.Pass;if("literal"==top){if(/^\{\/literal}/.test(textAfter))indent-=config.indentUnit}else{if(/^\s*\{\/(template|deltemplate)\b/.test(textAfter))return 0;if(/^\{(\/|(fallbackmsg|elseif|else|ifempty)\b)/.test(textAfter))indent-=config.indentUnit;if("switch"!=state.tag&&/^\{(case|default)\b/.test(textAfter))indent-=config.indentUnit;if(/^\{\/switch\b/.test(textAfter))indent-=config.indentUnit}var localState=last(state.localStates);if(indent&&localState.mode.indent){indent+=localState.mode.indent(localState.state,textAfter)}return indent},innerMode:function(state){if(state.soyState.length&&"literal"!=last(state.soyState))return null;else return last(state.localStates)},electricInput:/^\s*\{(\/|\/template|\/deltemplate|\/switch|fallbackmsg|elseif|else|case|default|ifempty|\/literal\})$/,lineComment:"//",blockCommentStart:"/*",blockCommentEnd:"*/",blockCommentContinue:" * ",useInnerComments:!1,fold:"indent"}},"htmlmixed");CodeMirror.registerHelper("hintWords","soy",indentingTags.concat(["delpackage","namespace","alias","print","css","debugger"]));CodeMirror.defineMIME("text/x-soy","soy")});